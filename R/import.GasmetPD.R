#' Import function for the GasmetPD multiplexer from the University of Padova
#'
#' Imports single raw gas measurement files from the GasmetPD, a custom made
#' multiplexer
#' (\ifelse{html}{\out{CO<sub>2</sub>}}{\eqn{CO[2]}{ASCII}},
#' \ifelse{html}{\out{CH<sub>4</sub>}}{\eqn{CH[4]}{ASCII}},
#' \ifelse{html}{\out{N<sub>2</sub>O}}{\eqn{N[2]O}{ASCII}},
#' \ifelse{html}{\out{NO<sub>2</sub>}}{\eqn{NO[2]}{ASCII}}, NO,
#' \ifelse{html}{\out{NH<sub>3</sub>}}{\eqn{NH[3]}{ASCII}} and
#' \ifelse{html}{\out{H<sub>2</sub>O}}{\eqn{H[2]O}{ASCII}})
#'
#' @param inputfile character string; the name of a file with the extension .txt
#' @param date.format character string; specifies the date format found in the
#'                    raw data file. Choose one of the following: "dmy", "ymd",
#'                    or "mdy". Default is "ymd", as it is the date format from
#'                    the example data file provided.
#' @param timezone character string; a time zone in which to import the data to
#'                 POSIXct format. Default is "UTC". Note about time zone: it is
#'                 recommended to use the time zone "UTC" to avoid any issue
#'                 related to summer time and winter time changes.
#' @param save logical; if \code{save = TRUE}, saves the file as an .RData file
#'             in a RData folder in the current working directory. If
#'             \code{save = FALSE}, returns the file in the Console, or load in
#'             the Environment if assigned to an object.
#' @param keep_all logical; if \code{keep_all = TRUE}, keep all columns from the raw
#'                 file. The default is \code{keep_all = FALSE}, and columns that
#'                 are not necessary for gas flux calculation are removed.
#' @param gas character vector; a pattern to match the columns containing each
#'            gas measurement. Choose from: "CO2dry_ppm", "CH4dry_ppb",
#'            "N2Odry_ppb", "NH3dry_ppb", "NO2_ppm", "NO_ppm" and "H2O_ppm".
#' @param prec numerical vector; the precision of the instrument for each gas.
#'             Note that the order in the arguments \code{precX} must match the
#'             order of the arguments in \code{gas}.
#'
#' @returns A data frame containing raw data from the custom made multiplexer
#'          GasmetPD, from the University of Padova, Italy.
#'
#' @include goFlux-package.R
#'
#' @details
#' In \code{date.format}, the date format refers to a date found in the raw data
#' file, not the date format in the file name. For this instrument, the date
#' is found in the column "Date".
#'
#' Note that this function was designed for the following units in the raw file:
#' \itemize{
#'   \item ppm for \ifelse{html}{\out{CO<sub>2</sub>}}{\eqn{CO[2]}{ASCII}},
#'   \ifelse{html}{\out{CH<sub>4</sub>}}{\eqn{CH[4]}{ASCII}},
#'   \ifelse{html}{\out{N<sub>2</sub>O}}{\eqn{N[2]O}{ASCII}},
#'   \ifelse{html}{\out{NO<sub>2</sub>}}{\eqn{NO[2]}{ASCII}}, NO and
#'   \ifelse{html}{\out{NH<sub>3</sub>}}{\eqn{NH[3]}{ASCII}}
#'   \item percent (\%) for \ifelse{html}{\out{H<sub>2</sub>O}}{\eqn{H[2]O}{ASCII}}
#'   \item mbar for pressure}
#' The function converts ambient pressure to kPa (Pcham), water vapor to ppm,
#' and \ifelse{html}{\out{CH<sub>4</sub>}}{\eqn{CH[4]}{ASCII}},
#' \ifelse{html}{\out{N<sub>2</sub>O}}{\eqn{N[2]O}{ASCII}},
#' \ifelse{html}{\out{NO<sub>2</sub>}}{\eqn{NO[2]}{ASCII}}, NO and
#' \ifelse{html}{\out{NH<sub>3</sub>}}{\eqn{NH[3]}{ASCII}} to ppb. If your
#' instrument uses different units, either convert the units after import,
#' change the settings on your instrument, or contact the maintainer
#' of this package for support.
#'
#' The precision of the instrument is needed to restrict kappa-max
#' (\code{\link[goFlux]{k.max}}) in the non-linear flux calculation
#' (\code{\link[goFlux]{HM.flux}}). Kappa-max is inversely proportional to
#' instrument precision. If the precision of your instrument is unknown, it is
#' better to use a low value (e.g. 1 ppm for
#' \ifelse{html}{\out{CO<sub>2</sub>}}{\eqn{CO[2]}{ASCII}} and
#' \ifelse{html}{\out{H<sub>2</sub>O}}{\eqn{H[2]O}{ASCII}}, or 1 ppb for
#' \ifelse{html}{\out{CH<sub>4</sub>}}{\eqn{CH[4]}{ASCII}},
#' \ifelse{html}{\out{N<sub>2</sub>O}}{\eqn{N[2]O}{ASCII}},
#' \ifelse{html}{\out{NO<sub>2</sub>}}{\eqn{NO[2]}{ASCII}}, NO and
#' \ifelse{html}{\out{NH<sub>3</sub>}}{\eqn{NH[3]}{ASCII}}) to allow for more
#' curvature, especially for water vapor fluxes, or very long measurements, that
#' are normally curved. The default values given for instrument precision are
#' the ones provided by the manufacturer upon request, for the latest model of
#' this instrument available at the time of the creation of this function (07-2024).
#'
#' @seealso Use the wrapper function \code{\link[goFlux]{import2RData}}
#'          to import multiple files from the same folder path using any instrument.
#' @seealso See also, import functions for other instruments:
#'          \code{\link[goFlux]{import.DX4015}},
#'          \code{\link[goFlux]{import.EGM5}},
#'          \code{\link[goFlux]{import.G2201i}},
#'          \code{\link[goFlux]{import.G2508}},
#'          \code{\link[goFlux]{import.G4301}},
#'          \code{\link[goFlux]{import.GAIA}},
#'          \code{\link[goFlux]{import.GT5000}},
#'          \code{\link[goFlux]{import.LI6400}},
#'          \code{\link[goFlux]{import.LI7810}},
#'          \code{\link[goFlux]{import.LI7820}},
#'          \code{\link[goFlux]{import.LI8100}},
#'          \code{\link[goFlux]{import.LI8200}},
#'          \code{\link[goFlux]{import.LI8250}},
#'          \code{\link[goFlux]{import.N2OM1}},
#'          \code{\link[goFlux]{import.uCH4}},
#'          \code{\link[goFlux]{import.uN2O}},
#'          \code{\link[goFlux]{import.UGGA}}
#'
#' @seealso See \code{\link[base]{timezones}} for a description of the underlying
#'          timezone attribute.
#'
#' @examples
#' # Load file from downloaded package
#' file.path <- system.file("extdata", "GasmetPD/GasmetPD.txt", package = "goFlux")
#'
#' # Run function
#' imp.GasmetPD <- import.GasmetPD(inputfile = file.path)
#' @export

import.GasmetPD <- function(inputfile, date.format = "ymd", timezone = "UTC",
                            save = FALSE, keep_all = FALSE,
                            gas = c("CO2_ppm", "CH4_ppm", "N2O_ppm", "NH3_ppm", "H2O_pct"),
                            prec = c(1.6, 13, 2, 23, 33)){

  # Check arguments
  if (missing(inputfile)) stop("'inputfile' is required")
  if (!is.character(inputfile)) stop("'inputfile' must be of class character")
  if (length(date.format) != 1) stop("'date.format' must be of length 1")
  if (!is.character(date.format)) stop("'date.format' must be of class character")
  if (!any(grepl(date.format, c("ymd", "dmy", "mdy")))) {
    stop("'date.format' must be one of the following: 'ymd', 'dmy' or 'mdy'")}
  if (!is.character(timezone)) stop("'timezone' must be of class character")
  if (save != TRUE & save != FALSE) stop("'save' must be TRUE or FALSE")
  if(keep_all != TRUE & keep_all != FALSE) stop("'keep_all' must be TRUE or FALSE")
  if(is.null(gas)) stop("'gas' is required") else{
    if(!is.character(gas)) stop("'gas' must be of class character")}
  if(is.null(prec)) stop("'prec' is required") else{
    if(!is.numeric(prec)) stop("'prec' must be of class numeric") else{
      if(length(prec) != length(gas)) stop("'prec' must be the same length as 'gas'")}}

  # Assign NULL to variables without binding
  POSIX.warning <- import.error <- . <- CH4dry_ppm <- N2Odry_ppm <- flag <-
    NH3dry_ppm <- H2O_pct <- CO2dry_ppm <- CH4dry_ppb <- N2Odry_ppb <-
    NH3dry_ppb <- H2O_ppm <- Date <- Time <- ID <- amb.press_mbar <- DATE <-
    meas_time <- starting_time <- chamID <- POSIX.time <- cham.close <-
    NO2dry_ppm <- NOdry_ppm <- NULL

  # Input file name
  inputfile.name <- gsub(".*/", "", inputfile)

  # Try to load data file
  try.import <- tryCatch(
    {read.delim(inputfile)},
    error = function(e) {import.error <<- e}
  )

  if(inherits(try.import, "simpleError")){
    warning("Error occurred in file ", inputfile.name, ":\n", "   ",
            import.error, call. = F)
  } else {

    # Match column names from gas
    for(i in 1:length(gas)){
      if(!any(grepl(gas[i], names(try.import)))){
        stop(paste("Failed to import ", inputfile.name, ". The matching ",
                   "string for gas '", gas[i], "' was not found in ",
                   "column names.", sep =""))}}

    # Load data file
    data.raw <- try.import %>%
      # Add "dry" to gas column names
      setNames(gsub("_ppm", "dry_ppm", names(.))) %>%
      # Convert H2O_pct to H2O_ppm
      mutate(H2O_ppm = H2O_pct*10000) %>%
      # Rename DATE and TIME
      rename(DATE = Date, TIME = Time) %>%
      mutate(DATE = gsub("/", "-", sub(" ", "" , DATE))) %>%
      # Create chamID
      rename(chamID = ID) %>%
      # Convert ambient pressure to kPa
      mutate(Pcham = amb.press_mbar*0.1)

    # Convert ppm to ppb for CH4, N2O, NO2, NO and NH3
    if(any(grepl("CH4_ppm", gas))){
      data.raw <- mutate(data.raw, CH4dry_ppb = CH4dry_ppm*1000)}
    if(any(grepl("N2O_ppm", gas))){
      data.raw <- mutate(data.raw, N2Odry_ppb = N2Odry_ppm*1000)}
    if(any(grepl("NH3_ppm", gas))){
      data.raw <- mutate(data.raw, NH3dry_ppb = NH3dry_ppm*1000)}
    if(any(grepl("NO2_ppm", gas))){
      data.raw <- mutate(data.raw, NO2dry_ppb = NO2dry_ppm*1000)}
    if(any(grepl("NO_ppm", gas))){
      data.raw <- mutate(data.raw, NOdry_ppb = NOdry_ppm*1000)}

    # Remove columns that are not used for gas flux calculations
    if(keep_all == FALSE){
      data.raw <- data.raw %>%
        # Remove meas_time, starting_time and amb.press_mbar
        select(!c(meas_time, starting_time, amb.press_mbar))
      if(any(grepl("CH4_ppm", gas))) data.raw <- select(data.raw, !CH4dry_ppm)
      if(any(grepl("N2O_ppm", gas))) data.raw <- select(data.raw, !N2Odry_ppm)
      if(any(grepl("NH3_ppm", gas))) data.raw <- select(data.raw, !NH3dry_ppm)
      if(any(grepl("NO2_ppm", gas))) data.raw <- select(data.raw, !NO2dry_ppm)
      if(any(grepl("NO_ppm", gas))) data.raw <- select(data.raw, !NOdry_ppm)
      if(any(grepl("H2O_pct", gas))) data.raw <- select(data.raw, !H2O_pct)
    }

    # Create a new column containing date and time (POSIX format)
    tryCatch(
      {op <- options()
      options(digits.secs=6)
      if(date.format == "dmy"){
        try.POSIX <- as.POSIXct(dmy_hms(paste(data.raw$DATE, data.raw$TIME), tz = timezone),
                                format = "%Y-%m-%d %H:%M:%OS")
      } else if(date.format == "mdy"){
        try.POSIX <- as.POSIXct(mdy_hms(paste(data.raw$DATE, data.raw$TIME), tz = timezone),
                                format = "%Y-%m-%d %H:%M:%OS")
      } else if(date.format == "ymd"){
        try.POSIX <- as.POSIXct(ymd_hms(paste(data.raw$DATE, data.raw$TIME), tz = timezone),
                                format = "%Y-%m-%d %H:%M:%OS")}
      options(op)}, warning = function(w) {POSIX.warning <<- "date.format.error"}
    )

    if(isTRUE(POSIX.warning == "date.format.error")){
      warning("Error occurred in file ", inputfile.name, ":\n",
              "   An error occured while converting DATE and TIME into POSIX.time.\n",
              "   Verify that the 'date.format' you specified (", date.format,
              ") corresponds to the\n",
              "   column 'Date' in the raw data file. Here is a sample: ",
              data.raw$DATE[1], "\n", call. = F)
    } else {

      data.raw$POSIX.time <- try.POSIX

      # Create flag, cham.close, cham.open
      data.raw <- data.raw %>%
        mutate(flag = if_else(mode == "Interpolation", 1, 0)) %>%
        group_by(chamID) %>%
        mutate(cham.close = first(POSIX.time),
               cham.open = last(POSIX.time)) %>% ungroup()

      # Create start.time
      start.time <- filter(data.raw, flag == 1) %>%
        group_by(chamID) %>% summarise(start.time = first(POSIX.time))

      data.raw <- left_join(data.raw, start.time, by = "chamID")

      # Create deadband and Etime
      data.raw <- data.raw %>%
        mutate(deadband = as.numeric(start.time - cham.close, units = "secs"),
               Etime = as.numeric(POSIX.time - start.time, units = "secs"))

      # Add instrument precision for each gas
      match_prec <- cbind.data.frame(gas, prec) %>%
        mutate(gas = gsub("_...", "_prec", gas))
      data.raw[match_prec$gas] <- 1
      for(i in 1:nrow(match_prec)){
        data.raw <- mutate_at(data.raw, match_prec$gas[i], ~match_prec$prec[i])}

      # Save cleaned data file
      if(save == TRUE){
        # Create RData folder in working directory
        RData_folder <- paste(getwd(), "RData", sep = "/")
        if(dir.exists(RData_folder) == FALSE){dir.create(RData_folder)}

        # Create output file: change extension to .RData, and
        # add instrument name and "imp" for import to file name
        file.name <- gsub(".*/", "", sub("\\.txt", "", inputfile))
        outputfile <- paste("GasmetPD_", file.name, "_imp.RData", sep = "")

        save(data.raw, file = paste(RData_folder, outputfile, sep = "/"))

        message(inputfile.name, " saved as ", outputfile,
                " in RData folder, in working directory\n", sep = "")
      }

      if(save == FALSE){
        return(data.raw)
      }
    }
  }
}
